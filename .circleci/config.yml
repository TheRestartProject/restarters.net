version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2204:current
    resource_class: large
    environment:
      - TZ: "UTC"

    steps:
      - checkout
      
      # Install Task
      - run:
          name: Install Task
          command: |
            sudo sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
            task --version

      # Set up environment file
      - run:
          name: Setup environment
          command: |
            cp .env.example .env
            
            # Configure for Docker Compose setup
            sed -i 's/DB_HOST=.*$/DB_HOST=restarters_db/g' .env
            sed -i 's/DB_DATABASE=.*$/DB_DATABASE=restarters_db_test/g' .env
            sed -i 's/DB_USERNAME=.*$/DB_USERNAME=restarters/g' .env
            sed -i 's/DB_PASSWORD=.*$/DB_PASSWORD=s3cr3t/g' .env
            
            # Configure Discourse integration
            sed -i 's/FEATURE__DISCOURSE_INTEGRATION=.*$/FEATURE__DISCOURSE_INTEGRATION=true/g' .env
            sed -i 's/DISCOURSE_URL=.*$/DISCOURSE_URL=http:\/\/restarters_discourse/g' .env
            sed -i 's/DISCOURSE_APIKEY=.*$/DISCOURSE_APIKEY=fb71f38ca2b8b7cd6a041e57fd8202c9937088f0ecae7db40722bd758dda92fc/g' .env
            sed -i 's/DISCOURSE_APIUSER=.*$/DISCOURSE_APIUSER=someuser/g' .env
            
            # Configure for testing
            sed -i 's/APP_DEBUG=.*$/APP_DEBUG=FALSE/g' .env
            sed -i 's/SESSION_DOMAIN=.*$/SESSION_DOMAIN=localhost/g' .env
            sed -i 's/HONEYPOT_DISABLE=.*$/HONEYPOT_DISABLE=TRUE/g' .env
            sed -i 's/APP_URL=.*$/APP_URL=http:\/\/localhost:8001/g' .env
            
            # Add environment variables from CircleCI
            echo "" >> .env
            echo "GOOGLE_API_CONSOLE_KEY=$GOOGLE_API_CONSOLE_KEY" >> .env
            echo "MAPBOX_TOKEN=$MAPBOX_TOKEN" >> .env

      # Start Docker services using Task
      - run:
          name: Start Docker services
          command: |
            # Start all services using Task
            task docker:up-all
          no_output_timeout: 10m

      # Wait for initial application build to complete
      - run:
          name: Wait for application build
          command: |
            echo "Waiting for initial application build to complete..."
            # Wait for build completion by checking for expected build artifacts
            max_attempts=60  # 10 minutes total
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              if docker exec restarters bash -c "[ -f public/mix-manifest.json ] || [ -f public/css/app.css ]"; then
                echo "✓ Application build complete - build artifacts found"
                break
              fi
              echo "  Build not complete, waiting... (attempt $((attempt + 1))/$max_attempts)"
              sleep 10
              attempt=$((attempt + 1))
            done
            if [ $attempt -eq $max_attempts ]; then
              echo "⚠️  Build artifacts not found after $max_attempts attempts, proceeding anyway"
            fi

      # Wait for services to be ready
      - run:
          name: Wait for services
          command: |
            task docker:wait-for-services-all

      # Setup database and application
      - run:
          name: Setup application
          command: |
            # Grant timezone access - run directly on MySQL container
            docker exec restarters_db mysql -u root -ps3cr3t -e "GRANT SELECT ON mysql.time_zone_name TO 'restarters'@'%';"
            
            # Setup additional configuration needed for CI (most setup already done by docker_run.sh)
            # Set MySQL function creators using session variable (compatible with MySQL 5.7)
            docker exec restarters_db mysql -u root -ps3cr3t -e "SET GLOBAL log_bin_trust_function_creators = 1;"
            
            # Generate additional Laravel artifacts for testing
            docker exec restarters php artisan l5-swagger:generate

      # Setup Discourse API
      - run:
          name: Setup Discourse
          command: |
            # Add API key to Discourse - run directly on PostgreSQL container
            docker exec postgresql psql -U postgres -c "INSERT INTO api_keys (id, user_id, created_by_id, created_at, updated_at, allowed_ips, hidden, last_used_at, revoked_at, description, key_hash, truncated_key) VALUES (1, NULL, 1, '2021-10-25 13:56:20.033338', '2021-10-25 13:56:20.033338', NULL, false, NULL, NULL, 'Restarters', 'd89e9dfacfb611fbaf004807648187ce7ed474df44dcb0ada230fab5c8dd6a5b', '9fd7');" bitnami_discourse
            
            # Configure Discourse settings
            docker exec restarters php artisan discourse:setting personal_message_enabled_groups 10

      # Run PHPUnit tests
      - run:
          name: Run PHPUnit tests
          command: |
            # Create test results directory on host
            mkdir -p /tmp/test-results/phpunit
            # Run PHPUnit with JUnit XML output - using direct docker exec to avoid quote issues
            docker exec restarters bash -c "export XDEBUG_MODE=coverage; ./vendor/bin/phpunit -d memory_limit=1024M --bootstrap vendor/autoload.php --coverage-clover tests/clover.xml --log-junit /tmp/phpunit-results.xml --configuration ./phpunit.xml"
            # Copy test results to host
            docker cp restarters:/tmp/phpunit-results.xml /tmp/test-results/phpunit/results.xml
          no_output_timeout: 45m

      # Upload coverage
      - run:
          name: Upload coverage
          command: |
            docker exec -e COVERALLS_REPO_TOKEN="$COVERALLS_REPO_TOKEN" restarters bash -c "mkdir -p build/logs && php vendor/bin/php-coveralls -v -x tests/clover.xml"

      # Run Jest tests
      - run:
          name: Run Jest tests
          command: |
            # Create test results directory for Jest
            mkdir -p /tmp/test-results/jest
            # Run Jest with JUnit output
            docker exec restarters bash -c "npm run jest -- --outputFile=/tmp/jest-results.xml --testResultsProcessor=jest-junit"
            # Copy test results to host if they exist
            docker cp restarters:/tmp/jest-results.xml /tmp/test-results/jest/results.xml || echo "Jest results not found, skipping"

      # Prepare for Playwright tests
      - run:
          name: Prepare for Playwright tests
          command: |
            # Clean up test data that might interfere - run directly on MySQL container
            docker exec restarters_db mysql -u root -ps3cr3t -e "use restarters_db_test;SET foreign_key_checks=0;DELETE FROM \`groups\` WHERE location IS NULL;SET foreign_key_checks=1;"
            docker exec restarters php artisan cache:clear
            
            # Create test user
            docker exec restarters bash -c "echo \"App\\\\User::firstOrCreate(['email'=>'jane@bloggs.net'], ['name'=>'Jane Bloggs','password'=>Hash::make('passw0rd'),'role'=>2,'consent_past_data'=>'2021-01-01','consent_future_data'=>'2021-01-01','consent_gdpr'=>'2021-01-01']);\" | php artisan tinker" || true
            
            # Build assets
            docker exec restarters bash -c "export NODE_OPTIONS=--max-old-space-size=8192; npm rebuild node-sass; npm run prod"
            
            # Disable API throttling for tests
            docker exec restarters bash -c "sed -i 's/.throttle:api.,//g' /var/www/app/Http/Kernel.php"

      # Run Playwright tests
      - run:
          name: Run Playwright tests
          command: |
            # Create test results directory for Playwright
            mkdir -p /tmp/test-results/playwright
            # Run Playwright tests with proper output directory
            docker exec restarters bash -c "export PLAYWRIGHT_DEBUG=true; export DEBUG=playwright; export PLAYWRIGHT_BASE_URL=http://localhost:8001; npx playwright test --reporter=junit --output-dir=/tmp/playwright-results"
            # Copy test results and artifacts to host
            docker cp restarters:/tmp/playwright-results /tmp/test-results/playwright/ || echo "Playwright results not found, skipping"
          no_output_timeout: 10m

      # Store artifacts
      - store_artifacts:
          path: /tmp/test-results
          destination: playwright-test-results
      
      - store_test_results:
          path: /tmp/test-results
