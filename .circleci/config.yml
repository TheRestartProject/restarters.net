version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2204:current
    resource_class: large
    environment:
      - TZ: "UTC"

    steps:
      - checkout
      
      # Install Task
      - run:
          name: Install Task
          command: |
            sudo sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
            task --version

      # Set up environment file
      - run:
          name: Setup environment
          command: |
            cp .env.example .env
            
            # Configure for Docker Compose setup
            sed -i 's/DB_HOST=.*$/DB_HOST=restarters_db/g' .env
            sed -i 's/DB_DATABASE=.*$/DB_DATABASE=restarters_db_test/g' .env
            sed -i 's/DB_USERNAME=.*$/DB_USERNAME=restarters/g' .env
            sed -i 's/DB_PASSWORD=.*$/DB_PASSWORD=s3cr3t/g' .env
            
            # Configure Discourse integration
            sed -i 's/FEATURE__DISCOURSE_INTEGRATION=.*$/FEATURE__DISCOURSE_INTEGRATION=true/g' .env
            sed -i 's/DISCOURSE_URL=.*$/DISCOURSE_URL=http:\/\/restarters_discourse/g' .env
            sed -i 's/DISCOURSE_APIKEY=.*$/DISCOURSE_APIKEY=fb71f38ca2b8b7cd6a041e57fd8202c9937088f0ecae7db40722bd758dda92fc/g' .env
            sed -i 's/DISCOURSE_APIUSER=.*$/DISCOURSE_APIUSER=someuser/g' .env
            
            # Configure for testing
            sed -i 's/APP_DEBUG=.*$/APP_DEBUG=FALSE/g' .env
            sed -i 's/SESSION_DOMAIN=.*$/SESSION_DOMAIN=localhost/g' .env
            sed -i 's/HONEYPOT_DISABLE=.*$/HONEYPOT_DISABLE=TRUE/g' .env
            sed -i 's/APP_URL=.*$/APP_URL=http:\/\/localhost:8001/g' .env
            
            # Add environment variables from CircleCI
            echo "" >> .env
            echo "GOOGLE_API_CONSOLE_KEY=$GOOGLE_API_CONSOLE_KEY" >> .env
            echo "MAPBOX_TOKEN=$MAPBOX_TOKEN" >> .env

      # Start Docker services using Task
      - run:
          name: Start Docker services
          command: |
            # Set environment variable for CircleCI detection
            export CIRCLECI=true
            # Enable Docker Compose bake for build optimization
            export COMPOSE_BAKE=true
            # Start all services using Task
            task docker:up-all
          no_output_timeout: 10m

      # Wait for initial application build to complete
      - run:
          name: Wait for application build
          command: |
            echo "Waiting for initial application build to complete..."
            # Wait for build completion by checking for expected build artifacts
            max_attempts=60  # 10 minutes total
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              if docker exec restarters bash -c "[ -f public/mix-manifest.json ] || [ -f public/css/app.css ]"; then
                echo "✓ Application build complete - build artifacts found"
                break
              fi
              echo "  Build not complete, waiting... (attempt $((attempt + 1))/$max_attempts)"
              sleep 10
              attempt=$((attempt + 1))
            done
            if [ $attempt -eq $max_attempts ]; then
              echo "⚠️  Build artifacts not found after $max_attempts attempts, proceeding anyway"
            fi

      # Wait for services to be ready
      - run:
          name: Wait for services
          command: |
            task docker:wait-for-services-all

      # Setup database and application
      - run:
          name: Setup application
          command: |
            # Grant timezone access - run directly on MySQL container
            docker exec restarters_db mysql -u root -ps3cr3t -e "GRANT SELECT ON mysql.time_zone_name TO 'restarters'@'%';"
            
            # Setup additional configuration needed for CI (most setup already done by docker_run.sh)
            # Set MySQL function creators using session variable (compatible with MySQL 5.7)
            docker exec restarters_db mysql -u root -ps3cr3t -e "SET GLOBAL log_bin_trust_function_creators = 1;"
            
            # Generate additional Laravel artifacts for testing
            docker exec restarters php artisan l5-swagger:generate

      # Setup Discourse API
      - run:
          name: Setup Discourse
          command: |
            # Add API key to Discourse - run directly on PostgreSQL container
            docker exec postgresql psql -U postgres -c "INSERT INTO api_keys (id, user_id, created_by_id, created_at, updated_at, allowed_ips, hidden, last_used_at, revoked_at, description, key_hash, truncated_key) VALUES (1, NULL, 1, '2021-10-25 13:56:20.033338', '2021-10-25 13:56:20.033338', NULL, false, NULL, NULL, 'Restarters', 'd89e9dfacfb611fbaf004807648187ce7ed474df44dcb0ada230fab5c8dd6a5b', '9fd7');" bitnami_discourse
            
            # Configure Discourse settings
            docker exec restarters php artisan discourse:setting personal_message_enabled_groups 10

      # Run PHPUnit tests
      - run:
          name: Run PHPUnit tests
          command: |
            # Create test results directory on host
            mkdir -p /tmp/test-results/phpunit
            # Run PHPUnit with JUnit XML output - using direct docker exec to avoid quote issues
            docker exec restarters bash -c "export XDEBUG_MODE=coverage; ./vendor/bin/phpunit -d memory_limit=1024M --bootstrap vendor/autoload.php --coverage-clover tests/clover.xml --log-junit /tmp/phpunit-results.xml --configuration ./phpunit.xml --teamcity"
            # Copy test results to host
            docker cp restarters:/tmp/phpunit-results.xml /tmp/test-results/phpunit/results.xml
          no_output_timeout: 45m

      # Upload coverage
      - run:
          name: Upload coverage
          command: |
            docker exec -e COVERALLS_REPO_TOKEN="$COVERALLS_REPO_TOKEN" restarters bash -c "mkdir -p build/logs && php vendor/bin/php-coveralls -v -x tests/clover.xml"

      # Run Jest tests
      - run:
          name: Run Jest tests
          command: |
            # Create test results directory for Jest
            mkdir -p /tmp/test-results/jest
            # Run Jest with JUnit output
            docker exec restarters bash -c "npm i jest-junit; JEST_JUNIT_OUTPUT_DIR=/tmp/test-results npm run jest -- --testResultsProcessor=jest-junit"
            # Copy test results to host if they exist
            docker cp restarters:/tmp/test-results/junit.xml /tmp/test-results/jest/junit.xml || echo "Jest results not found, skipping"

      # Prepare for Playwright tests
      - run:
          name: Prepare for Playwright tests
          command: |
            docker exec restarters php artisan cache:clear
            
            # Delete all devices from database to ensure clean state for Playwright tests
            docker exec restarters bash -c "echo \"DB::statement('SET foreign_key_checks=0'); App\\\\Device::truncate(); DB::statement('SET foreign_key_checks=1');\" | php artisan tinker" || true
            
            # Create test user
            docker exec restarters bash -c "echo \"App\\\\User::firstOrCreate(['email'=>'jane@bloggs.net'], ['name'=>'Jane Bloggs','password'=>Hash::make('passw0rd'),'role'=>2,'consent_past_data'=>'2021-01-01','consent_future_data'=>'2021-01-01','consent_gdpr'=>'2021-01-01']);\" | php artisan tinker" || true
            
            # Build assets
            docker exec restarters bash -c "export NODE_OPTIONS=--max-old-space-size=8192; npm run build"
            
            # Disable API throttling for tests
            docker exec restarters bash -c "sed -i 's/.throttle:api.,//g' /var/www/app/Http/Kernel.php"

      # Run main Playwright tests (excluding autocomplete)
      - run:
          name: Run main Playwright tests
          command: |
            mkdir -p /tmp/test-results/playwright
            # Create Playwright results directory inside container and run tests
            # Use -t flag for pseudo-TTY to ensure unbuffered output
            docker exec -t restarters bash -c "
              export PLAYWRIGHT_TEST=true
              export PLAYWRIGHT_DEBUG=true
              export PWTEST_SKIP_TEST_OUTPUT=0
              export DEBUG=playwright
              export PLAYWRIGHT_BASE_URL=http://restarters_nginx
              export PW_TEST_HTML_REPORT_OPEN=never
              export FORCE_COLOR=1
              # Unbuffer output and add periodic keepalive
              stdbuf -oL -eL npx playwright test --reporter=html | while IFS= read -r line; do
                echo \"\$line\"
                echo '[CircleCI] Playwright test running...' >&2
              done
            "
          no_output_timeout: 10m

      # Setup test data for autocomplete test
      - run:
          name: Setup autocomplete test data
          command: |
            echo "Setting up test data for autocomplete test..."
            # Run tinker script and check for success message instead of exit code
            docker exec restarters bash -c "
              php artisan tinker setup-autocomplete-test-data.php > /tmp/setup-output.log 2>&1
              if grep -q 'Test data setup complete!' /tmp/setup-output.log; then
                echo 'Setup completed successfully!'
                cat /tmp/setup-output.log
                exit 0
              else
                echo 'Setup failed!'
                cat /tmp/setup-output.log
                exit 1
              fi
            "
          no_output_timeout: 5m

      # Run autocomplete Playwright test separately because it needs special setup.
      - run:
          name: Run autocomplete Playwright test
          command: |
            mkdir -p /tmp/test-results/playwright-autocomplete
            # Run the autocomplete test with its own configuration
            # Use -t flag for pseudo-TTY and add background keepalive process
            docker exec -t restarters bash -c "
              export PLAYWRIGHT_TEST=true
              export PLAYWRIGHT_DEBUG=true
              export PWTEST_SKIP_TEST_OUTPUT=0
              export DEBUG=playwright
              export PLAYWRIGHT_BASE_URL=http://restarters_nginx
              export PW_TEST_HTML_REPORT_OPEN=never
              export FORCE_COLOR=1
              
              # Start background keepalive process
              (while true; do sleep 30; echo '[CircleCI] Autocomplete test still running...'; done) &
              KEEPALIVE_PID=\$!
              
              # Run the test with unbuffered output
              stdbuf -oL -eL npx playwright test --config=playwright.autocomplete.config.js --reporter=html
              
              # Clean up keepalive process
              kill \$KEEPALIVE_PID 2>/dev/null || true
            "
          no_output_timeout: 15m

      # Copy test results and artifacts
      - run:
          name: Copy Playwright artifacts
          command: |
            # List what's available in the container
            docker exec restarters bash -c "ls -la /tmp/test-results/* || echo 'No playwright directories found'"
            # Copy test results and artifacts to host if they exist
            docker cp restarters:/tmp/test-results /tmp/test-results/playwright/ || echo "Playwright HTML report not found"
          when: always

      # Store artifacts
      - store_artifacts:
          path: /tmp/test-results
          destination: playwright-test-results
      
      - store_test_results:
          path: /tmp/test-results
