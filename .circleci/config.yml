version: 2.1

jobs:
  build:
    machine:
      image: ubuntu-2204:current
    resource_class: large
    environment:
      - TZ: "UTC"

    steps:
      - checkout
      
      # Install Task
      - run:
          name: Install Task
          command: |
            sudo sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /usr/local/bin
            task --version

      # Set up environment file
      - run:
          name: Setup environment
          command: |
            cp .env.example .env
            
            # Configure for Docker Compose setup
            sed -i 's/DB_HOST=.*$/DB_HOST=restarters_db/g' .env
            sed -i 's/DB_DATABASE=.*$/DB_DATABASE=restarters_db_test/g' .env
            sed -i 's/DB_USERNAME=.*$/DB_USERNAME=restarters/g' .env
            sed -i 's/DB_PASSWORD=.*$/DB_PASSWORD=s3cr3t/g' .env
            
            # Configure Discourse integration
            sed -i 's/FEATURE__DISCOURSE_INTEGRATION=.*$/FEATURE__DISCOURSE_INTEGRATION=true/g' .env
            sed -i 's/DISCOURSE_URL=.*$/DISCOURSE_URL=http:\/\/restarters_discourse/g' .env
            sed -i 's/DISCOURSE_APIKEY=.*$/DISCOURSE_APIKEY=fb71f38ca2b8b7cd6a041e57fd8202c9937088f0ecae7db40722bd758dda92fc/g' .env
            sed -i 's/DISCOURSE_APIUSER=.*$/DISCOURSE_APIUSER=someuser/g' .env
            
            # Configure for testing
            sed -i 's/APP_DEBUG=.*$/APP_DEBUG=FALSE/g' .env
            sed -i 's/SESSION_DOMAIN=.*$/SESSION_DOMAIN=localhost/g' .env
            sed -i 's/HONEYPOT_DISABLE=.*$/HONEYPOT_DISABLE=TRUE/g' .env
            sed -i 's/APP_URL=.*$/APP_URL=http:\/\/localhost:8001/g' .env
            
            # Add environment variables from CircleCI
            echo "" >> .env
            echo "GOOGLE_API_CONSOLE_KEY=$GOOGLE_API_CONSOLE_KEY" >> .env
            echo "MAPBOX_TOKEN=$MAPBOX_TOKEN" >> .env

      # Start Docker services using Task
      - run:
          name: Start Docker services
          command: |
            # Set environment variable for CircleCI detection
            export CIRCLECI=true
            # Enable Docker Compose bake for build optimization
            export COMPOSE_BAKE=true
            # Start all services using Task
            task docker:up-all
          no_output_timeout: 10m

      # Wait for services to be ready (includes build completion and restart detection)
      - run:
          name: Wait for services
          command: |
            task docker:wait-for-services-all

      # Setup database and application
      - run:
          name: Setup application
          command: |
            # Grant timezone access - run directly on MySQL container
            docker exec restarters_db mysql -u root -ps3cr3t -e "GRANT SELECT ON mysql.time_zone_name TO 'restarters'@'%';"
            
            # Setup additional configuration needed for CI (most setup already done by docker_run.sh)
            # Set MySQL function creators using session variable (compatible with MySQL 5.7)
            docker exec restarters_db mysql -u root -ps3cr3t -e "SET GLOBAL log_bin_trust_function_creators = 1;"
            
            # Generate additional Laravel artifacts for testing
            docker exec restarters php artisan l5-swagger:generate

      # Setup Discourse API
      - run:
          name: Setup Discourse
          command: |
            # Add API key to Discourse - run directly on PostgreSQL container
            docker exec postgresql psql -U postgres -c "INSERT INTO api_keys (id, user_id, created_by_id, created_at, updated_at, allowed_ips, hidden, last_used_at, revoked_at, description, key_hash, truncated_key) VALUES (1, NULL, 1, '2021-10-25 13:56:20.033338', '2021-10-25 13:56:20.033338', NULL, false, NULL, NULL, 'Restarters', 'd89e9dfacfb611fbaf004807648187ce7ed474df44dcb0ada230fab5c8dd6a5b', '9fd7');" bitnami_discourse
            
            # Configure Discourse settings
            docker exec restarters php artisan discourse:setting personal_message_enabled_groups 10

      # Run PHPUnit tests
      - run:
          name: Run PHPUnit tests
          command: |
            # Run PHPUnit tests using Task for consistency with local development
            task docker:test:phpunit
            # Copy test results to host
            docker cp restarters:/tmp/phpunit-results.xml /tmp/test-results/phpunit/results.xml
          no_output_timeout: 45m

      # Run Jest tests
      - run:
          name: Run Jest tests
          command: |
            # Run Jest tests using Task for consistency with local development
            task docker:test:jest
            # Copy test results to host if they exist
            docker cp restarters:/tmp/test-results/junit.xml /tmp/test-results/jest/junit.xml || echo "Jest results not found, skipping"

      # Run main Playwright tests (excluding autocomplete)
      - run:
          name: Run main Playwright tests
          command: |
            # Run Playwright tests using Task for consistency with local development
            task docker:test:playwright
          no_output_timeout: 10m

      # Run autocomplete Playwright test separately because it needs special setup.
      - run:
          name: Run autocomplete Playwright test
          command: |
            # Run autocomplete Playwright tests using Task for consistency with local development
            task docker:test:playwright-autocomplete
          no_output_timeout: 15m

      # Copy test results and artifacts
      - run:
          name: Copy Playwright artifacts
          command: |
            # Create test results directory on host
            mkdir -p /tmp/test-results/playwright
            mkdir -p /tmp/test-results/logs

            # List what's available in the container
            docker exec restarters bash -c "ls -la /tmp/test-results/* || echo 'No playwright directories found'"

            # Copy test results and artifacts to host if they exist
            docker cp restarters:/tmp/test-results/. /tmp/test-results/playwright/ || echo "Playwright HTML report not found"

            # Copy Vite log for debugging
            docker cp restarters:/tmp/vite.log /tmp/test-results/logs/vite.log || echo "Vite log not found"
          when: always

      # Keep containers running for SSH debugging
      - run:
          name: Keep containers running for debugging
          command: |
            echo "=== DEBUGGING MODE ENABLED ==="
            echo "All containers are now running and ready for SSH debugging"
            echo "Available containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "To debug, SSH into this job and use:"
            echo "  docker exec -it restarters bash"
            echo "  docker exec -it restarters_db mysql -u restarters -ps3cr3t restarters_db_test"
            echo "  docker exec -it restarters_discourse bash"
            echo ""
            echo "Containers will stay running until you cancel the job or it times out (default 5h)"
            # Keep the containers running - this will timeout after CircleCI's default timeout
            while true; do
              echo "Containers still running... ($(date))"
              docker ps --format "table {{.Names}}\t{{.Status}}" | grep -v "NAME"
              sleep 300  # Check every 5 minutes
            done
          no_output_timeout: 5h
          when: always

      # Store artifacts
      - store_artifacts:
          path: /tmp/test-results
          destination: playwright-test-results
      
      - store_test_results:
          path: /tmp/test-results
