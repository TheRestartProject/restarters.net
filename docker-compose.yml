# Core docker-compose file for Restarters development environment
# Core Services:
# - Restarters web server: http://www.example.com:8001 (Admin: jane@bloggs.net/passw0rd)
# - A Database: Exposed on port 3306 internally
#
# TODO The domain name could be better but needs some configuration on the Discourse images which is hard.
# TODO It doesn't yet include the wiki.
# TODO If your host is Linux, this probably only works if you run as root.
#
# On the machine where you will be using your browser to access the Restarters / Discourse sites once set up on Docker,
# add a record to your hosts file to point the domain www.example.com to the machine.
#
# Then start using:
# - docker-compose up -d
#
# The Restarters web server won't be available for some time after that finishes - it will be doing a composer
# install, artisan migrate etc. Discourse also takes quite a few minutes to finish initialising.  You can monitor
# progress using:
#
# docker logs --follow restarters
#
# (or via Docker Desktop's UI on Windows).   Check for any obvious errors.
#
# Then:
# - edit .env and set GOOGLE_API_CONSOLE_KEY to the dev key.
# TODO This isn't checked in to the codebase, but once this works on Circle then we can put it in an env variable and edit it in via docker_run.sh.
# - log in to the restarters container using: docker exec -it restarters bash
# - run UT using: export DB_TEST_HOST=restarters_db; php vendor/phpunit/phpunit/phpunit --configuration ./phpunit.xml
# TODO This isn't a very convenient way to do run tests.  Would be good to enable SSH on the Restarter container so
# that JetBrains and other IDEs can trigger the running of tests.
#
# If you want to remove everything to free up disk space or force a complete rebuild (e.g. as a sanity check
# after changing this configuration):
# - docker-compose down -v --rmi all --remove-orphans
#

version: '3'
services:

  restarters:
    depends_on:
      - restarters_db
    build:
      context: .
      dockerfile: Dockerfile
    image: php:7.4
    user: root
    container_name: restarters
    restart: unless-stopped
    tty: true
    ports:
      - "8001:80"
    environment:
      SERVICE_NAME: restarters
      SERVICE_TAGS: dev
    working_dir: /var/www
    volumes:
      # We share the current folder into /var/www.  This means code changes on the host will get picked up
      # by the client.
      - ./:/var/www:rw
      - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini
    networks:
      - app-network

  restarters_db:
    image: mysql:5.7.33
    container_name: restarters_db
    restart: unless-stopped
    tty: true
    expose:
      - "3306"
    environment:
      MYSQL_DATABASE: restarters_db_test
      MYSQL_ROOT_PASSWORD: s3cr3t
      MYSQL_USER: restarters
      MYSQL_PASSWORD: s3cr3t
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - dbdata:/var/lib/mysql
      - ./mysql/my.cnf:/etc/mysql/my.cnf
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  dbdata:
    driver: local